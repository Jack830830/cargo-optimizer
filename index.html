<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>協會貨運計算機</title>
<style>
:root {
    --main-background: #F0F2F5;
    --main-border: #DDD;
    --main-overlay: #00000088;
    --table-background: #4A90E2;
    --card-background: #FFF;
    --card-shadow: #00000022;
    
    
    --button-background: #4A90E2;
    
    --main-description-text: #777;

    --price-low: green;
    --price-high: red;
}
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display:flex; flex-direction: column; gap:20px; padding:20px; background:var(--main-background); }
h2 { margin-top: 0; padding-top: 0; }
.col { width:100%; }
.card { background: var(--card-background); border-radius:8px; padding:16px; box-shadow:0 4px 10px var(--card-shadow); }
.table-wrapper { overflow-x: auto; width: 100%; }
table { width: 100%; border-collapse: collapse; margin-top: 8px; table-layout: auto; word-break: break-word; }
th,td { border:1px solid var(--main-border); padding:8px; text-align:center; }
th { background: var(--table-background); font-weight:600; }
input[type=number]{ width:80px; padding:4px; border-radius:4px; border:1px solid var(--main-border); text-align:center; }
select{ width:200px; padding:4px; border-radius:4px; border:1px solid var(--main-border); }
button {
  border: none;
  border-radius: 4px;
  height: 2rem;
  cursor: pointer;
  background-color: var(--button-background);
  min-width: 120px;
  font-weight: 700;
}
button:hover {
  color: white;
  transform: translateY(-0.8px);
  filter: brightness(1.15);
}
.button-shift {
  margin-top: 1rem;
  margin-left: 1rem;
}
.short-button {
  height:1.6rem;
  margin-left: 0.4rem;
  min-width: 25px;
}
.combo b { padding:2px 4px; border-radius:4px; color: var(--main-background); }
.result p { margin:6px 0; font-size:1rem; }
.result span { font-weight:bold; }
.price-low { color: var(--price-low); font-weight:bold; }
.price-high { color: var(--price-high); font-weight:bold; }
    .modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
}
.modal-content {
  background: #fff;
  width: 380px;
  padding: 20px;
  margin: 80px auto;
  border-radius: 8px;
  position: relative;
  max-height: 80%;
  overflow-y: auto;
}
.modal-close {
  position: absolute;
  right: 12px;
  top: 8px;
  cursor: pointer;
  font-size: 22px;
}
#overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--main-overlay);
  z-index: 9999;
  cursor: wait;
  
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column; 
  gap: 10px;  

  opacity: 0;
  animation: overlayfadeIn 0.5s forwards;
}
#overlay .text {
  color: white;
  font-size: 24px;
  font-weight: bold;
}
#overlay-text {
  display: inline-block;
}
#overlay .text .dots::after {
  content: '';
  display: inline-block;
  width: 1em;
  text-align: left;
  animation: dots 1s steps(3, end) infinite;
}
@keyframes overlayfadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}
@keyframes dots {
  0%, 20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%, 100% { content: '...'; }
}
</style>
</head>
<body>
<h1>協會貨運計算機 V0.1版</h1>
<div style="display:flex; gap:20px;">
  <div class="col">
    <div class="card">
      <h2>貨運今日高價物品</h2>
      <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>#</th><th>類別 / 物品名稱</th><th>裝載量</th><th>盧諾單價</th></tr>
            </thead>
            <tbody id="slots"></tbody>
          </table>
      </div>
      <button id="update-price" class="button-shift" onclick="updateAllPrices()">↺ 更新價格</button>
    </div>
  </div>

  <div class="col">
    <div class="card">
      <h2>計算最優結果</h2>
      <div id="resLowest" class="result"><em>--</em></div>
      <br>
      <div style="color:var(--main-description-text); font-size: 0.75rem;">計算: 價格最低 > 裝載量最低</div>
      
  <button id="reportBtn" class="button-shift">⚠ 回報問題</button>
  <!-- Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>

      <h2>回報問題</h2>

      <!-- Step 1: 選類型 -->
      <label>回報類型：</label>
      <select id="reportType">
        <option value="item_error">1. 物品資訊錯誤</option>
        <option value="missing_item">2. 新增物品</option>
        <option value="other_issue">3. 計算錯誤 / 其他問題</option>
      </select>

      <div id="reportBody" style="margin-top: 15px;"></div>

      <button id="reportSubmit" style="margin-top: 20px; width: 100%;">送出回報</button>
    </div>
  </div>
    </div>
  </div>
</div>

<div id="overlay" style="display:none;"><div class="text"><span id="overlay-text"></span><span class="dots"></span></div></div>


<script src="https://unpkg.com/@supabase/supabase-js@2.86.0/dist/umd/supabase.js"></script>

<script>
const supabaseUrl = 'https://tdlogwmrfswqyxoouizw.supabase.co';
const supabaseKey = 'sb_publishable_0dSV0uhQ6qJOGpts6IsIfA_f9Fox0u4';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, { auth: { persistSession: false } });
    
const categoryColors = {
  "植生學": "#2E8B57",
  "礦物學": "#708090",
  "晶石學": "#8A2BE2",
  "烹飪": "#ff9800",
  "煉金": "#4B0082",
  "鍛造": "#B22222",
  "織造": "#DA70D6",
  "木作": "#8B4513", 
  "工藝": "#CD853F",
  "釣魚": "#1E90FF"
};

async function loadItems() {
    const { data, error } = await supabaseClient
        .from("items")
        .select("*")
        .order("name");

    if (error) {
        console.error("supabaseClient 讀取錯誤:", error);
        return [];
    }

    return data;
}
async function updateAllPrices() {
    document.getElementById('overlay-text').textContent = "更新價格中";
    document.getElementById('overlay').style.display = 'flex';
    
    const updates = [];

    for (let s = 0; s < 8; s++) {
        const sel = document.getElementById(`sel_${s}`);
        const priceInput = document.getElementById(`p_${s}`);

        if (!sel || !priceInput) continue;
        if (sel.value === "") continue;

        const newPrice = Number(priceInput.value);
        updates.push({
            name: sel.value,
            price: newPrice
        });
    }

    for (let u of updates) {
        const { error } = await supabaseClient
            .from("items")
            .update({ price: u.price })
            .eq("name", u.name);

        if (error) {
            console.error("更新失敗:", u.name, error);
        }
    }

    items = await loadItems();
    generateSlots();
    recompute();
    
    document.getElementById('update-price').textContent = "↺ 更新價格";
    document.getElementById('overlay').style.display = 'none';

    alert("價格更新成功！");
}
    
let items = [];
    
const target = 20000;

function generateSlots(){
    const tbody = document.getElementById('slots');
    tbody.innerHTML='';
    for(let i=0;i<8;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${i+1}</td>
        <td style="display:flex; gap:8px; justify-content:center; align-items:center;">
          <select id="cat_${i}" onchange="updateItemOptions(${i}); recompute();"></select>
          <select id="sel_${i}" onchange="updateSlot(${i}); recompute();"></select>
        </td>
        <td><input type="number" id="w_${i}" disabled></td>
        <td><input type="number" id="p_${i}" onchange="recompute()"></td>
        `;
        tbody.appendChild(tr);
        populateCategoryOptions(i);
        updateItemOptions(i);
    }
}

function populateCategoryOptions(i){
    const catSel = document.getElementById(`cat_${i}`);
    catSel.innerHTML = Object.keys(categoryColors).map(cat=>`<option value="${cat}" style="color:${categoryColors[cat]}">${cat}</option>`).join('');
    catSel.selectedIndex = 0;
}

function updateItemOptions(i){
    const catSel = document.getElementById(`cat_${i}`);
    catSel.style.color = categoryColors[catSel.value] || "#000";
    const sel = document.getElementById(`sel_${i}`);
    const cat = catSel.value;
    const filtered = items.filter(it => it.category === cat);
    sel.innerHTML = filtered.map(it=>`<option value="${it.name}" style="color:${categoryColors[it.category]}">${it.name}</option>`).join('');
    sel.selectedIndex = 0;
    updateSlot(i);
}

function updateSlot(i){
    const sel = document.getElementById(`sel_${i}`);
    const it = items.find(x=>x.name===sel.value);
    if(!it) return;
    sel.style.color = categoryColors[it.category] || "#000";
    document.getElementById(`w_${i}`).value = it.weight;
    document.getElementById(`p_${i}`).value = it.price;
}


function recompute(){
    function preprocess(selected){
        const map = {};
        for(const it of selected){
            const key = it.weight;
            if(!map[key] || it.price < map[key].price) {
                map[key] = {name: it.name, weight: it.weight, price: it.price, category: it.category};
            }
        }
        return Object.values(map);
    }

    const selected=[];
    for(let i=0;i<8;i++){
        const sel = document.getElementById(`sel_${i}`).value;
        const w = Number(document.getElementById(`w_${i}`).value);
        const p = Number(document.getElementById(`p_${i}`).value);
        const it = items.find(x=>x.name===sel);
        selected.push({name:sel, weight:w, price:p, category: it.category});
    }

    const types = preprocess(selected); // 用於背包計算

    const maxWeight = 100000;
    const dp = Array(maxWeight+1).fill(Infinity);
    const pick = Array(maxWeight+1).fill(null);
    dp[0] = 0;

    for(const it of types){
        for(let w=it.weight; w<=maxWeight; w++){
            if(dp[w-it.weight]+it.price < dp[w]){
                dp[w] = dp[w-it.weight]+it.price;
                pick[w] = it.name;
            }
        }
    }

    let bestW = target;
    let minPrice = Infinity;
    for(let w=target; w<=maxWeight; w++){
        if(dp[w] < minPrice){
            minPrice = dp[w];
            bestW = w;
        }
    }

    // 回溯計算每個選擇的數量
    let w = bestW;
    const counts = {};
    while(w>0){
        const name = pick[w];
        if(!name) break;
        counts[name] = (counts[name]||0)+1;
        const it = types.find(x=>x.name===name);
        w -= it.weight;
    }

    // 渲染組合
    function render(res, dom){
        const combo = [];
        for(const name of Object.keys(res.counts)){
            if(res.counts[name] <= 0) continue;
            const it = types.find(x=>x.name===name);

            // 從原始 selected 找所有同 weight + price 名稱，去重
            const samePriceWeight = selected
                .filter(x => x.weight===it.weight && x.price===it.price)
                .map(x => x.name);
            const uniqueNames = [...new Set(samePriceWeight)];

            const color = categoryColors[it.category] || "#000";
            combo.push(`<b style="color:${color}">${uniqueNames.join('/')}</b> × ${res.counts[name]}`);
        }

        const priceClass = res.price < 18000 ? 'price-low' : 'price-high';
        dom.innerHTML = `<p>總裝載量: <span>${res.weight}</span>, 總盧諾價格: <span class="${priceClass}">${res.price}</span></p>
                        <p>組合: ${combo.join('、') || '<em>無</em>'}</p>`;
    }
    render({weight: bestW, price: dp[bestW], counts}, document.getElementById('resLowest'));
}

// 初始化
loadItems().then(data => {
      items = data;
    
    generateSlots();
    recompute();
});

//回報功能
async function submitReport(payload) {
    const { data, error } = await supabaseClient
        .from("report")
        .insert([payload]);

    if (error) {
        console.error("送出回報失敗:", error);
        alert("送出回報失敗，請稍後再試！");
        return false;
    }
    alert("感謝回報！");
    return true;
}

// 打開/關閉 modal
const modal = document.getElementById("reportModal");
document.getElementById("reportBtn").onclick = () => {
    modal.style.display = "block";
    const reportType = document.getElementById("reportType");
    if(!reportType.value) reportType.selectedIndex = 0;
    reportType.dispatchEvent(new Event('change'));
};
document.querySelector(".modal-close").onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

// 當選擇 reportType 後產生不同 UI
document.getElementById("reportType").addEventListener("change", function () {
  let type = this.value;
  let body = document.getElementById("reportBody");
  body.innerHTML = "";

  if (type === "item_error") {
    // 選 category -> 選 item
    body.innerHTML = `
      <label>選擇類別：</label>
      <select id="errorCategory" style="margin-bottom: 10px;"></select><br>

      <label>選擇物品：</label>
      <select id="errorItem" style="margin-bottom: 10px;"></select><br>

      <label style="display:block; margin-top:10px;">描述問題：</label>
      <textarea id="errorDesc" rows="4" style="width:100%; height: 10rem; "></textarea>
    `;

    const catSel = document.getElementById("errorCategory");
    const itemSel = document.getElementById("errorItem");

    catSel.innerHTML = Object.keys(categoryColors)
      .map(cat => `<option value="${cat}" style="color:${categoryColors[cat]}">${cat}</option>`)
      .join("");
    catSel.selectedIndex = 0;
    catSel.style.color = categoryColors[catSel.value] || "#000";
    
    function updateErrorItems() {
        const sel = document.getElementById("errorItem");
        const cat = catSel.value;
        const filtered = items.filter(it => it.category === cat);
        sel.innerHTML = filtered.map(it=>`<option value="${it.id}" style="color:${categoryColors[it.category]}">${it.name}</option>`).join('');
        itemSel.selectedIndex = 0;
        const it = items.find(x => x.id == itemSel.value);
        if(it) itemSel.style.color = categoryColors[it.category] || "#000";
    }
    
    catSel.addEventListener("change", () => {
        catSel.style.color = categoryColors[catSel.value] || "#000";
        updateErrorItems();
    });

    updateErrorItems(); // 初始化

  } else if (type === "missing_item") {
    body.innerHTML = `

      <div id="missingList" style="margin-top:10px;"></div>

      <button class="short-button" onclick="addMissingItem()" style="margin-top:10px;">  +  </button><br><br>
      
      <label>備註：</label>
      <textarea id="missingNote" rows="2" style="width:100%; height: 10rem;"></textarea>
    `;

    addMissingItem();
  } else if (type === "other_issue") {
    body.innerHTML = `
      <label>回報者 ID：</label>
      <input id="otherID" style="width:100%;" />

      <label style="margin-top:10px;">問題主旨：</label>
      <input id="otherTitle" maxlength="50" style="width:100%;" />

      <label style="margin-top:10px; display:block;">問題描述：</label>
      <textarea id="otherDesc" rows="4" style="width:100%; height: 10rem;"></textarea>
    `;
  }
});

function addMissingItem() {
  let box = document.getElementById("missingList");

  let div = document.createElement("div");
  div.className = "missingItemRow";
  div.style.marginBottom = "8px";

  div.innerHTML = `
    <input placeholder="物品名稱" class="miName" style="width:20%; height:1.2rem;">
    <input placeholder="裝載量" class="miWeight" style="width:20%; height:1.2rem;">
    <input placeholder="盧諾單價" class="miPrice" style="width:20%; height:1.2rem;">
    <select placeholder="類別" class="miCat" style="width:20%;"></select>
    </select>
    <button class="short-button" onclick="this.parentNode.remove()">-</button>
  `;

  box.appendChild(div);

  function updateMiCatColor(selectElement) {
    const val = selectElement.value;
    selectElement.style.color = categoryColors[val] || "#000";
  }
  
  const catSel = div.querySelector(".miCat");
  catSel.innerHTML = Object.keys(categoryColors)
    .map(cat => `<option value="${cat}" style="color:${categoryColors[cat]}">${cat}</option>`)
    .join('');
  catSel.selectedIndex = 0;
  catSel.style.color = categoryColors[catSel.value] || "#000";

  // 改變顏色事件
  catSel.addEventListener("change", () => {
    catSel.style.color = categoryColors[catSel.value] || "#000";
  });
}

// 送出回報
document.getElementById("reportSubmit").onclick = async () => {
  let type = document.getElementById("reportType").value;
  if(!type) return alert("請先選擇回報類型");
  let payload = { report_type: type };

  if (type === "item_error") {
    payload.item_id = document.getElementById("errorItem").value;
    payload.description = document.getElementById("errorDesc").value;
  } else if (type === "missing_item") {
    payload.description = document.getElementById("missingNote").value;
    payload.items_data = [];
    document.querySelectorAll(".missingItemRow").forEach(r => {
      payload.items_data.push({
        name: r.querySelector(".miName").value,
        weight: r.querySelector(".miWeight").value,
        price: r.querySelector(".miPrice").value,
        category: r.querySelector(".miCat").value,
      });
    });
  } else if (type === "other_issue") {
    payload.reporter_id = document.getElementById("otherID").value;
    payload.title = document.getElementById("otherTitle").value;
    payload.description = document.getElementById("otherDesc").value;
  }

  await submitReport(payload);

  modal.style.display = "none";
};
</script>
</body>

</html>

