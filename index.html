<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>協會貨運計算機</title>
<style>
:root {
    --main-background: #F0F2F5;
    --main-border: #DDD;
    --table-background: #E8E8F5;
    --card-background: #FFF;
    --card-shadow: #00000022;
    
    --main-description-text: #777;

    --price-low: green;
    --price-high: red;
}
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display:flex; gap:20px; padding:20px; background:var(--main-background); }
h2 { margin-top: 0; padding-top: 0; }
.col { width:100%; }
.card { background: var(--card-background); border-radius:8px; padding:16px; box-shadow:0 4px 10px var(--card-shadow); }
.table-wrapper { overflow-x: auto; width: 100%; }
table { width: 100%; border-collapse: collapse; margin-top: 12px; table-layout: auto; word-break: break-word; }
th,td { border:1px solid var(--main-border); padding:8px; text-align:center; }
th { background: var(--table-background); font-weight:600; }
input[type=number]{ width:80px; padding:4px; border-radius:4px; border:1px solid var(--main-border); text-align:center; }
select{ width:200px; padding:4px; border-radius:4px; border:1px solid var(--main-border); }
.combo b { padding:2px 4px; border-radius:4px; color: var(--main-background); }
.result p { margin:6px 0; font-size:1rem; }
.result span { font-weight:bold; }
.price-low { color: var(--price-low); font-weight:bold; }
.price-high { color: var(--price-high); font-weight:bold; }
    .modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
}
.modal-content {
  background: #fff;
  width: 380px;
  padding: 20px;
  margin: 80px auto;
  border-radius: 8px;
  position: relative;
}
.modal-close {
  position: absolute;
  right: 12px;
  top: 8px;
  cursor: pointer;
  font-size: 22px;
}
</style>
</head>
<body>
<div class="col">
  <div class="card">
    <h2>貨運今日高價物品</h2>
    <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>#</th><th>類別 / 物品名稱</th><th>裝載量</th><th>盧諾單價</th></tr>
          </thead>
          <tbody id="slots"></tbody>
        </table>
    </div>
    <button onclick="updateAllPrices()">更新價格</button>
  </div>
</div>

<div class="col">
  <div class="card">
    <h2>計算最優結果</h2>
    <div id="resLowest" class="result"><em>--</em></div>
    <br>
    <div style="color:var(--main-description-text); font-size: 0.75rem;">計算: 價格最低 > 裝載量最低</div>
  </div>
</div>

<button id="reportBtn">回報問題</button>
<!-- Modal -->
<div id="reportModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>

    <h2>回報問題</h2>

    <!-- Step 1: 選類型 -->
    <label>回報類型：</label>
    <select id="reportType">
      <option value="" disabled selected>請選擇</option>
      <option value="item_error">1. Items 資訊錯誤</option>
      <option value="missing_item">2. 欠缺 Items</option>
      <option value="other_issue">3. 計算錯誤 / 其他問題</option>
    </select>

    <div id="reportBody" style="margin-top: 15px;"></div>

    <button id="reportSubmit" style="margin-top: 20px; width: 100%;">送出回報</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
const supabaseUrl = "https://tdlogwmrfswqyxoouizw.supabase.co";
const supabaseKey = "sb_publishable_0dSV0uhQ6qJOGpts6IsIfA_f9Fox0u4";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    
const categoryColors = {
  "植生學": "#2E8B57",
  "礦物學": "#708090",
  "晶石學": "#8A2BE2",
  "烹飪": "#ff9800",
  "煉金": "#4B0082",
  "鍛造": "#B22222",
  "織造": "#DA70D6",
  "木作": "#8B4513", 
  "工藝": "#CD853F",
  "釣魚": "#1E90FF"
};

async function loadItems() {
    const { data, error } = await supabase
        .from("items")
        .select("*")
        .order("name");

    if (error) {
        console.error("Supabase 讀取錯誤:", error);
        return [];
    }

    return data;
}
async function updateAllPrices() {
    const updates = [];

    for (let s = 0; s < 8; s++) {
        const sel = document.getElementById(`sel_${s}`);
        const priceInput = document.getElementById(`p_${s}`);

        if (!sel || !priceInput) continue;
        if (sel.value === "") continue; // 沒選 item 的跳過

        const newPrice = Number(priceInput.value);

        updates.push({
            name: sel.value,
            price: newPrice
        });
    }

    // 批次更新（推薦）
    for (let u of updates) {
        const { error } = await supabase
            .from("items")
            .update({ price: u.price })
            .eq("name", u.name);

        if (error) {
            console.error("更新失敗:", u.name, error);
        }
    }

    alert("已更新 8 個欄位中的有效項目！");
}
    
let items = [];
    
const target = 20000;

function generateSlots(){
    const tbody = document.getElementById('slots');
    tbody.innerHTML='';
    for(let i=0;i<8;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${i+1}</td>
        <td style="display:flex; gap:8px; justify-content:center; align-items:center;">
          <select id="cat_${i}" onchange="updateItemOptions(${i}); recompute();"></select>
          <select id="sel_${i}" onchange="updateSlot(${i}); recompute();"></select>
        </td>
        <td><input type="number" id="w_${i}" disabled></td>
        <td><input type="number" id="p_${i}" onchange="recompute()"></td>
        `;
        tbody.appendChild(tr);
        populateCategoryOptions(i);
        updateItemOptions(i);
    }
}

function populateCategoryOptions(i){
    const catSel = document.getElementById(`cat_${i}`);
    catSel.innerHTML = Object.keys(categoryColors).map(cat=>`<option value="${cat}" style="color:${categoryColors[cat]}">${cat}</option>`).join('');
    catSel.selectedIndex = 0;
}

function updateItemOptions(i){
    const catSel = document.getElementById(`cat_${i}`);
    catSel.style.color = categoryColors[catSel.value] || "#000";
    const sel = document.getElementById(`sel_${i}`);
    const cat = catSel.value;
    const filtered = items.filter(it => it.category === cat);
    sel.innerHTML = filtered.map(it=>`<option value="${it.name}" style="color:${categoryColors[it.category]}">${it.name}</option>`).join('');
    sel.selectedIndex = 0;
    updateSlot(i);
}

function updateSlot(i){
    const sel = document.getElementById(`sel_${i}`);
    const it = items.find(x=>x.name===sel.value);
    if(!it) return;
    sel.style.color = categoryColors[it.category] || "#000";
    document.getElementById(`w_${i}`).value = it.weight;
    document.getElementById(`p_${i}`).value = it.price;
}


function recompute(){
    function preprocess(selected){
        const map = {};
        for(const it of selected){
            const key = it.weight;
            if(!map[key] || it.price < map[key].price) {
                map[key] = {name: it.name, weight: it.weight, price: it.price, category: it.category};
            }
        }
        return Object.values(map);
    }

    const selected=[];
    for(let i=0;i<8;i++){
        const sel = document.getElementById(`sel_${i}`).value;
        const w = Number(document.getElementById(`w_${i}`).value);
        const p = Number(document.getElementById(`p_${i}`).value);
        const it = items.find(x=>x.name===sel);
        selected.push({name:sel, weight:w, price:p, category: it.category});
    }

    const types = preprocess(selected); // 用於背包計算

    const maxWeight = 100000;
    const dp = Array(maxWeight+1).fill(Infinity);
    const pick = Array(maxWeight+1).fill(null);
    dp[0] = 0;

    for(const it of types){
        for(let w=it.weight; w<=maxWeight; w++){
            if(dp[w-it.weight]+it.price < dp[w]){
                dp[w] = dp[w-it.weight]+it.price;
                pick[w] = it.name;
            }
        }
    }

    let bestW = target;
    let minPrice = Infinity;
    for(let w=target; w<=maxWeight; w++){
        if(dp[w] < minPrice){
            minPrice = dp[w];
            bestW = w;
        }
    }

    // 回溯計算每個選擇的數量
    let w = bestW;
    const counts = {};
    while(w>0){
        const name = pick[w];
        if(!name) break;
        counts[name] = (counts[name]||0)+1;
        const it = types.find(x=>x.name===name);
        w -= it.weight;
    }

    // 渲染組合
    function render(res, dom){
        const combo = [];
        for(const name of Object.keys(res.counts)){
            if(res.counts[name] <= 0) continue;
            const it = types.find(x=>x.name===name);

            // 從原始 selected 找所有同 weight + price 名稱，去重
            const samePriceWeight = selected
                .filter(x => x.weight===it.weight && x.price===it.price)
                .map(x => x.name);
            const uniqueNames = [...new Set(samePriceWeight)];

            const color = categoryColors[it.category] || "#000";
            combo.push(`<b style="color:${color}">${uniqueNames.join('/')}</b> × ${res.counts[name]}`);
        }

        const priceClass = res.price < 18000 ? 'price-low' : 'price-high';
        dom.innerHTML = `<p>總裝載量: <span>${res.weight}</span>, 總盧諾價格: <span class="${priceClass}">${res.price}</span></p>
                        <p>組合: ${combo.join('、') || '<em>無</em>'}</p>`;
    }
    render({weight: bestW, price: dp[bestW], counts}, document.getElementById('resLowest'));
}

// 初始化
loadItems().then(data => {
      items = data;
    
    generateSlots();
    recompute();
});

//回報功能
// 打開/關閉 modal
const modal = document.getElementById("reportModal");
document.getElementById("reportBtn").onclick = () => modal.style.display = "block";
document.querySelector(".modal-close").onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };


// 當選擇 reportType 後產生不同 UI
document.getElementById("reportType").addEventListener("change", function () {
  let type = this.value;
  let body = document.getElementById("reportBody");

  if (type === "item_error") {
    body.innerHTML = `
      <label>選擇 item：</label>
      <select id="errorItem">
        ${items.map(i => `<option value="${i.id}">${i.name}</option>`).join("")}
      </select>

      <label style="margin-top:10px;">描述問題：</label>
      <textarea id="errorDesc" rows="4" style="width:100%;"></textarea>
    `;
  }

  else if (type === "missing_item") {
    body.innerHTML = `
      <label>備註（可選）：</label>
      <textarea id="missingNote" rows="2" style="width:100%;"></textarea>

      <div id="missingList" style="margin-top:10px;"></div>

      <button onclick="addMissingItem()" style="margin-top:10px;">+ 新增一筆</button>
    `;

    addMissingItem(); // 先給一筆空白
  }

  else if (type === "other_issue") {
    body.innerHTML = `
      <label>回報者 ID：</label>
      <input id="otherID" style="width:100%;" />

      <label style="margin-top:10px;">問題主旨（50 字內）：</label>
      <input id="otherTitle" maxlength="50" style="width:100%;" />

      <label style="margin-top:10px;">問題描述：</label>
      <textarea id="otherDesc" rows="4" style="width:100%;"></textarea>
    `;
  }
});


// (缺少 items) 新增一筆
function addMissingItem() {
  let box = document.getElementById("missingList");

  let div = document.createElement("div");
  div.className = "missingItemRow";
  div.style.marginBottom = "8px";

  div.innerHTML = `
    <input placeholder="name" class="miName" style="width:22%;">
    <input placeholder="weight" class="miWeight" style="width:22%;">
    <input placeholder="price" class="miPrice" style="width:22%;">
    <input placeholder="category" class="miCat" style="width:22%;">
    <button onclick="this.parentNode.remove()">-</button>
  `;

  box.appendChild(div);
}


// 送出回報
document.getElementById("reportSubmit").onclick = async () => {
  let type = document.getElementById("reportType").value;

  let payload = { report_type: type };

  // type 1：item 錯誤
  if (type === "item_error") {
    payload.item_id = document.getElementById("errorItem").value;
    payload.description = document.getElementById("errorDesc").value;
  }

  // type 2：缺 item
  else if (type === "missing_item") {
    payload.description = document.getElementById("missingNote").value;
    payload.items_data = [];

    document.querySelectorAll(".missingItemRow").forEach(r => {
      payload.items_data.push({
        name: r.querySelector(".miName").value,
        weight: r.querySelector(".miWeight").value,
        price: r.querySelector(".miPrice").value,
        category: r.querySelector(".miCat").value,
      });
    });
  }

  // type 3：操作問題
  else if (type === "other_issue") {
    payload.reporter_id = document.getElementById("otherID").value;
    payload.title = document.getElementById("otherTitle").value;
    payload.description = document.getElementById("otherDesc").value;
  }

  // 呼叫你原本的 Supabase 寫入 function
  await submitReport(payload);

  alert("感謝回報！");
  modal.style.display = "none";
};
</script>
</body>

</html>







